viewport:width=device-width,initial-scale=1

目录

[TOC]

##Ch8磁盘存储器的管理
磁盘存储器管理的要求

1. 有效地利用存储空间
	+ 采取合理的文件分配方式,为文件分配必要的存储空间,使每个文件各得其所
	同时减少磁盘碎片
2. 提高磁盘I/O速度
	+ 采用磁盘缓存等措施
3. 提高磁盘系统的可靠性
	+ 必要的冗余措施和后备系统
###8.1外存的组织方式

1. 连续组织方式:
	+ 为每个文件分配一片连续的磁盘空间
	+ 物理结构:顺序式文件结构
2. 链接组织方式:
	+ 为每个文件分配不连续的磁盘空间,通过链接指针将一个文件的所有盘块链接在一起
	+ 物理结构:链接式文件结构
3. 索引组织方式
####8.1.1连续组织方式
采用连续组织方式时,把逻辑文件中的记录顺序地存储到邻接的各物理盘块中
保证了逻辑文件中的记录顺序与存储器文件占用盘块的顺序一致

目录项的文件物理地址中记录:第一记录的盘块号+文件长度(以盘块为单位)

如同<u>内存的动态分区分配一样</u>
会有外零头的问题产生,可以通过"紧凑"的方法解决
但外存上的紧凑花费的时间远较内存的多

+ 优点:
	1. 顺序访问容易
		- : 找到第一个盘块号,逐个盘块地往下读/写
		- 对定长记录文件可随机存取
	2. 顺序访问速度块
		- 占用的盘块在相邻的磁道上,磁头移动的距离较少
+ 确定:
	1. 产生碎片,降低外存空间利用率
	定期紧凑又要花费大量时间
	2. 必须实现知道文件的长度
	3. 不能灵活的删除和插入记录
		+ 为保存记录的有序性,删除/插入记录时,都需要对相邻的记录做物理上的移动
	4. 对于动态增长的文件由于无法实现知道文件大小,难以分配空间
####8.1.2链接组织方式
将文件装到多个离散的盘块中
通过每个盘块上的链接指针将同属于一个文件的多个离散的盘块链接成一个链表
<u>主要优点</u>

1. 不会产生连续分配方式中的外部碎片问题
2. 方便插入删除
3. 能适应文件的动态增长,无需事先知道文件的大小


链接方式分为两种
#####隐式链接
文件的目录项中含有指向第一个盘块和最后一个盘块的指针
主要问题:

+ 只适合顺序访问,对随机访问极其低效
	- 要读第i个盘块,必须先从第一个盘块开始读
+ 可靠性较差

<u>为了提高检索速度和减小指针所占用的存储空间</u>
可将几个盘块组成一个**簇Cluster**
以簇为单位分配盘块
#####显式链接
把用于链接文件的个物理块的指针显示地存放在内容的一张链接表中
该表在整个磁盘中仅设置一张
$表的序号是物理盘块号,0-(N-1),盘块总数为N$
每个表项存放链接指针

<u>每一条链的首指针作为文件地址填入FCB的物理地址字段中</u>

查找记录的过程在内容中进行,速度显著提高

该表记录了分配给文件的所有盘块号,称为文件分配表FAT File Allocation Table
#####8.1.3FAT技术
$FAT12 \rightarrow FAT16 \rightarrow FAT32$
FAT中引入了"卷"的概念,一个物理磁盘分为多个逻辑磁盘,每个逻辑磁盘就是一个卷/分区
每个卷都是一个能够被单独格式化和使用的逻辑单元
每个卷专门划出一个单独区域来存放自己的目录和FAT表

1. FAT12
	+ 早期的FAT12,以盘块为基本分配单位
	+ 以簇为单位的FAT12文件系统
	同样的FAT表中的表项数目,基本分配单位越大,支持的磁盘的最大容量越大
		- 增加盘块的容量是不方便和不灵活的,引入了"簇"的概念
		簇:一组相邻的扇区,一个簇一般是$2n$个扇区
		- 会造成较大的簇内零头
2. FAT16
	+ FAT表中表项的位数限制了表项的数目
	所以把位数从12增大到了16
3. FAT32
	+ 再次增大位数到了32
	+ 好处:同样容量的磁盘,能支持更小的簇,从而提高了磁盘的利用率
	+ 不足:
		- FAT变大,运行速度变慢
		- FAT32有最小管理空间的限制,..不支持容量小于512MB的分区
		- 单个文件的长度不能大于4GB
			+ (因为文件长度字段占用4Byte,最大标识4GB-1
		- 不能保持向下兼容
#####8.1.4NTFS技术
NTFS New Technology File System
使用了64位磁盘地址
很好地支持常文件名
具有系统容错功能
能保证系统中的数据的一致性

+ 磁盘组织
	- 以簇作为磁盘空间分配和回收的基本单位
		+ 与磁盘物理块大小无关的独立性
			- 分配磁盘空间时,无需知道盘块的大小
	- 卷因子:卷上簇的大小,在格式化时确定
		+ 大多数情况下使用4KB大小的簇
	- 簇的定位:LCN逻辑簇号,VCN虚拟簇号
		+ LCN:以卷为单位,将整个卷中所有的簇按顺序进行简单的编号
		地址映射:通过$卷因子\times LCN$得到卷上的物理字节偏移量
		+ 为便于文件中数据的引用,
		NTFS使用VCN,以文件为单位,将属于某个文件的簇按顺序编号
		通过文件开始的簇地址<u>将VCN映射到LCN</u>
+ 文件的组织
	- 以卷为单位,将一个卷中的所有文件信息,目录信息以及可用的未分配空间信息
	以文件记录的方式记录到一张**主控文件表MFT(Master File Table)**中
		+ 卷中每个文件作为一条记录,在MFT中占有一行,每行大小固定为1KB,-元数据
	- 元数据将对应文件的所有信息(包括文件内容)组织在一组属性中
		+ 文件大小相差悬殊,属性所需空间大小也相差较大
			- 当文件较小时,可以将文件的所有属性直接记录在元数据中
				+ 将文件的内容直接记录进去...
			- 当文件较大时,将其余属性记录到其他可用簇中(根据属性分类形成队列),
			元数据记录下队列的指针

缺点:不能被广泛支持...
####8.1.5索引组织方式
<u>链接方式的缺点</u>,主要是关于不太适合随机访问/直接访问

1. 隐式链接组织方式,对随机访问极其低效
2. 使用显式链接直接存取/随机存取时
	+ **针对大文件,要在FAT中顺序的查找较多的盘号**
	+ 由于文件分配的盘块号是随机地分布在FAT中的,->要查找盘块号就要将整个FAT调入内存
	**FAT需要占用较大的内存空间**

打开文件时,遍历FAT表也只是为了得到文件所对应的所有盘号
**索引方式**:将文件所对应的盘号集中地放在一起,
为每个文件分配一个索引块(表),记录该文件的所有盘块号
在访问到某个文件时将文件对应的盘号调入内存
优点:**支持直接访问**
不会产生外部碎片
<u>当文件较大时,索引分配方式要优于链接分配方式</u>
主要问题:对于小文件,建立索引表很不划算


1. 单级索引组织方式
2. 多级索引组织方式
	+ 当文件特别大,索引块太多时,应该为索引块再建立索引
	+ 优点:大大加快了对大型文件的额查找速度
	+ 缺点:访问一个盘块时,需要启动的磁盘的次数随着索引级数增加而增多
3. 增量式索引组织方式
	+ 基本思想:全面照顾小,中,大,特型作业,采取多种组织方式来构成文件的物理结构
		- 小文件直接寻址
		- 中等文件单级索引
		- 大型,特大型文件,多级索引
	+ UNIX System V 的组织方式
	UNIX System V的索引结点中设有13个地址项
	盘块大小为4KB时,每个盘块号占用4B,一个盘块可以存放1K个盘块号
		- 0-9直接地址:直接盘块号,文件大小<= 40KB
		- 10一次间接地址,文件大小<=4MB+40KB
		- 11二次间址,文件大小<= 4GB+4MB+40KB
		- 12三次间址,文件大小...

####文件物理结构的比较
+ 顺序文件:
	- 顺序存取效率最高
		- 对于定长记录文件随机访问也很方便.
	- 但文件动态地增长和缩小系统开销很大
	- 文件创建时要求用户提供文件的大小
	- 存储空间浪费较大.
+ 隐式链接文件:
	- 克服了连续文件的不足之处,但不适合随机访问,可靠性差.
+ 显式链接文件:
	- 能随机访问,但对大文件随机访问性能差.
+ 单级,多级索引:
	- 既适合顺序访问,也适合随机访问,但索引表比较浪费文件存储空间(特别是小文件.
+ 混合索引:
	- 既适合顺序访问,也适合随机访问,比普通索引方式节约存储空间,是一种比较好的文件物理结构.
	- UNIX系统采用混合索引方式.

顺序文件,链接文件适合顺序访问,而索引文件既适合顺序访问又适合随机访问
###8.2文件存储空间的管理
要分配盘块,就要知道哪些盘块是可以分配的
磁盘分配表Disk Allocation Table,用于记住可供分配的存储空间的情况
<u>**基本分配单位是磁盘块,而非字节**</u>

####8.2.1空闲表法和空闲链表法
不适用与大型文件系统
1.空闲表法
	+ 空闲表
	连续分配方式,
	为外存上的所有空闲区建立一张空闲表:表项序号,空闲区第一个盘块号,空闲区盘块数目
	按空闲区其实盘块号递增的次序排列
	+ 存储空间的分配与回收
	分配,查找可分配空间的算法:首次适应法,最佳适应法,(最坏适应法)
	回收,:各种邻接情况来插入,合并
	+ 内存中较少使用这种连续分配方式,但外存中使用相对多
	(对换空间使用连续分配方式
2.空闲链表法
	+ 空闲链表:将所有空闲分区拉成一条空闲链
		- 空闲盘块链:以盘块为单位
		- 空闲盘区链:以盘区为单位
####8.2.2位示图法
1. 位示图:用一位的两种状态来表示空闲与已分配
	+ $map[m,n],m\times n等于磁盘的总块数$
2. 盘块的分配
	1. 顺序扫描为示图,从中找出一个或一组空闲的二进制位
	2. 将二进制位换算为盘块号
		+ 二维数组变一维...
	3. 修改位示图
3. 盘块的回收
	1. 将盘块号转换为行列号
	2. 修改位示图
####8.2.3成组链接法
空闲表和空闲链表用于大型文件系统时,表太长
将两种方法结合得到<u>成组链接法</u>
克服了表太长的缺点
![成组链接法示意图][0]
###8.3提高磁盘I/O速度的途径
###8.4提高磁盘可靠性的技术
###8.5数据一致性控制
[0]:http://cjhgo.sinaapp.com/CS/OperatingSystem/images/grouplink.gif