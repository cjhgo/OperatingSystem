viewport:width=device-width,initial-scale=1

目录

[TOC]

##Ch7文件管理
由用户直接管理存放在外存上的文件,不仅要求用户
<u>熟悉外存特性,了解各种文件的属性以及它们在外存上的位置
而且在多用户环境中还必须能保持数据的安全性和一致性.</u>
显然,这对用户来说过于麻烦
所以,操作系统中要有文件管理的功能
###7.1文件和文件系统
文件系统的管理功能是将其管理的程序和数据通过组织为一系列文件的方式实现的
**文件**则是指具有文件名的若干相关元素的集合
**元素**通常是记录
**记录**又是一组有意义的数据项的集合

<u>**基于文件系统的概念,可以把数据组成分为数据项,记录,和文件三级**</u>
####7.1.1数据项,记录和文件
1. 数据项
	- 型
		+ 数据名
		+ 数据类型
	- 值
2. 记录
3. 文件
	+ 有结构文件:由若干个相关记录组成
	+ 无结构文件:一个字符流
	+ 属性
		- 文件类型
		- 文件长度
		- 文件物理位置
		- 文件的建立时间
####7.1.2文件名和类型
1. 文件名和扩展名
2. 文件类型:文件分类方法
	+ 按用途
		- 系统文件
		- 用户文件
		- 库文件
	+ 按文件中的数据形式
		- 源文件
		- 目标文件
		- 可执行文件
	+ 按存取控制属性
		- 只执行文件
		- 只读文件
		- 读写文件
	+ 按组织形式和处理方式
		- 普通文件
		- 目录文件:由文件目录组成的文件,通过目录文件可以对其下属文件的信息进行检索
		- 特殊文件:系统中的各类I/O设备
####7.1.3文件系统的层次结构
|用户/程序|
|------------|
|文件系统接口|
|对(对象操作和管理)的软件集合|
|对象及其属性|

1. 对象及其属性
文件管理系统管理的对象:
	+ 文件
	+ 目录:为了方便用户<u>对文件的存取和检索</u>,在文件系统中配置目录,
	在目录的每个目录项中,必须含有文件名,对文件属性的说明,以及该文件所在的物理地址
	+ 磁盘存储空间:文件和目录占用存储空间
2. 操作和管理对象的软件集合:实现文件系统的功能
	+ 功能
		- 管理存储空间
		- 管理文件目录
		- **将文件的逻辑地址转换为物理地址**
		- 对文件读和写
		- 对文件的共享和保护
	+ 实现这些功能的层次组织结构
		1. I/O控制层:最底层,磁盘驱动程序
		2. 基本文件系统层:处理内存与磁盘之间数据块的交换
		3. 基本I/O管理层序:完成与磁盘I/O有关的事务,如:
			+ 将文件逻辑块号转换为物理块号,
			+ 管理磁盘中的空闲盘快
			+ I/O缓冲的指定
			+ ...
		4. 逻辑文件系统:处理与记录和文件相关的操作.如
			+ 允许用户和应用程序使用符号文件名访问文件及记录
			+ 实现对文件和记录的保护
			+ ...
3. 文件系统的接口:文件系统以接口的形式提供了一组对文件和记录操作的方法和手段
	+ 命令接口:用户与文件系统直接交互的接口
	+ 程序接口:用户程序通过系统调用取得文件系统的服务
####7.1.4文件操作
1. 最基本的文件操作
	+ 创建文件:
		- 为新文件分配必要的外存空间,
		- 在文件目录中为之建立一个目录项
			+ 目录项中应记录新文件的文件名及其在外存的地址等属性
	+ 删除文件
		- 先从目录中找到要删除文件的目录项,使之成为空项
		- 回收该文件占用的存储空间
	+ 读文件
	+ 写文件
	+ 设置文件的读写位置:
	读/写文件操作每次都是从文件的始端进行,
	"设置文件的读写位置"通过设置文件的读写指针位置,从所设置的位置开始操作
	改顺序存取为随机存取
2. 文件的打开和关闭
**为了避免多次重复的检索目录**
OS中引入了"打开"这一文件系统调用
	+ 当用户第一次请求对某文件进行操作时,须先利用open系统调用将该文件打开,
	所谓"打开":系统将指名文件的属性(包括了文件在外存的物理位置),
	从外存拷贝到<u>内存打开文件表</u>的一个表目中,并将该表明的编号返回给用户
	此后,用户再次向系统发出文件操作请求时,
	系统根据用户提供的索引号可以**直接在打开的文件表中查找到文件信息**
	"关闭":如果用户不再需要对该文件实施相应操作,OS将会把该文件从打开文件表中的表目上删除掉
3. 其他文件操作
	+ 对文件属性的操作,即允许用户直接设置和获得文件的属性
	+ 对目录的操作
	+ 实现文件共享的系统调用
	+ 对文件系统进行操作的系统调用
###7.2文件的逻辑结构
用户所看到的文件称为逻辑文件,是由一些列的逻辑记录组成的

+ 文件系统高层设计时,涉及到的是文件的逻辑结构:如何将逻辑记录构成一个逻辑文件
+ 文件系统底层设计时,设计到的是文件的物理结构:如何将一个文件存储在外存上

由此可见,系统中的文件都存在着两种形式的文件结构

+ **文件的逻辑结构**
+ **文件的物理结构/存储结构**

都会影响文件的检索速度
####7.2.1文件逻辑结构的类型
逻辑结构的基本要求

+ 便于检索
+ 便于修改
+ 占用较少的外存空间

**文件逻辑结构的类型/分类**

+ 按文件是否有结构分类
	- **无结构文件**:流式文件,由字符流组成
	<u>在系统中运行的大量的源程序,可执行文件,库函数等采用无结构的文件形式</u>
		+ 文件长度以字节为单位
	- **有结构文件**:记录式文件,由一个以上的记录构成
	<u>在信息管理系统和数据库系统中,广泛采用有结构的文件形式</u>
		+ 定长记录:文件中所有记录的长度是相同的
		+ 不定长记录:文件中各记录的长度不相同
		+ 文件长度用记录数目表示
+ 按文件的组织方式分类:**按文件的组织方式,可以把有结构文件分为三类**
	- 顺序文件:一系列记录按照某种顺序排列形成的文件
	- 索引文件:为可变长记录文件建立一张索引表,为每个记录设置一个表项
	加速对记录的检索速度
	- 索引顺序文件:为每个文件建立一张索引表时,不是为每一个记录建立一个索引表项,
	而是为一组记录中的第一个记录建立一个索引表项
####7.2.2顺序文件
+ 串结构:按存入时间先后进行排序
+ 顺序结构:由用户制定一个字段作为关键字,按关键字排序
	- 对顺序结构文件进行检索时,可以利用有效的查找算法

优缺点

+ 优点:最佳应用场合:对文件中的记录进行批量存取时
+ 缺点:
	- 查找/修改单个记录,需要逐个查找,性能差
	- 增删比较困难
		+ 一个解决方案:为顺序文件配置一个运行记录文件(log file)或事务文件(transaction file)
		把试图增/删/改的信息记录其中,每隔一定时间,将运行记录文件和原来的主文件加以合并,产生新文件
#####7.2.3记录寻址
访问顺序记录文件中一条记录,应该找到该记录的地址,
查找记录地址的方法

1. 隐式寻址方式
	+ 定长记录的顺序文件,设置读写指针,每次读写完毕后执行$R/WPtr=R/WPtr+L$
	+ 变长记录的顺序文件,每次需要从正在读写的记录中读取该记录的长度,$R/WPtr=R/WPtr+L_i$
		- 访问一个指定记录i,必须扫描/读取前面的所有记录才能得到它的位置
2. 显示寻址方式:**可用于对定长记录的文件实现直接或随机访问**
因为任何记录的位置都很容易通过记录长度计算出来
	+ 通过两种方式对定长记录实现随机访问
		- 通过文件中记录的位置
		- 利用关键字
			+ 可变长度基于关键字的记录:对目录的检索
####7.2.4索引文件Index File
1. 按关键字建立索引
为变长记录文件建立一张索引表,为主文件中的每个记录在索引表中分别设置一个表项
:记录指向记录的指针以及记录的长度
索引表按关键字排序,则索引表是一个定长记录的顺序文件
这样,就把对变长记录顺序文件的顺序检索转变为对定长记录索引文件的随机检索
2. 具有多个索引表的索引文件
为顺序文件建立多个索引表,满足按不同属性查找的需求
####7.2.5索引顺序文件
1. 索引顺序文件的特征
索引顺序文件是对顺序文件的一种改进,
**保留了顺序文件的关键特征:记录按关键字的顺序组织**
**克服了变长记录的顺序文件不能随机访问,不便于删除插入的缺点**
通过增加两个新特征
	+ 引入了文件索引表,通过该表实现对索引顺序文件的随机访问
	+ 增加了溢出文件,用它来记录新增的,删除的,修改的记录
2. 一级索引顺序文件
	+ 建立方法:
		- 将变长记录顺序文件中的所有记录分为若干个组:分组
		- 然后为顺序文件建立一张索引表,为组中的第一个记录在索引表中建立一个索引项
		其中含有该记录的关键字和指向该记录的指针
	+ 检索过程:
		- 根据用户/程序提供的关键字+某种查找算法,检索索引表,找到**该记录所在记录组中第一个记录的表项**
		从中得到该记录组第一个记录在主文件中的位置
		- 利用顺序查找法去查找主文件,从中找到所要找的记录
	+ 效率比较
		- $如果一个顺序文件中所含有的记录数为N,则为检索到具有指定关键字的记录\\\
		平均需要查找N/2个记录$
		- 但对于索引顺序文件,平均只需要查找$\sqrt{N}$
3. 两级索引顺序文件	
为进一步提高检索效率,可以为顺序文件建立多级索引
####7.2.6直接文件和哈希文件
1. 直接文件
根据给定的关键字直接获得指定记录的物理地址
(顺序文件,索引文件,索引顺序文件都是利用给定的记录键值通过检索得到物理地址)
键值转换:由关键字到记录物理地址的转换
2. 哈希文件
哈希文件是应用最为广泛的一种直接文件,利用哈希函数实现键值转换
**为了实现文件存储空间的动态分配**,键值转换得到的并非是记录的地址,
而是某一目录表相应表目的指针
####7.3文件目录
文件目录也是一种数据结构,用于标识系统中的文件及其物理地址,供检索时使用
目录管理的要求

+ 实现"按名存取"
+ 提高对目录的检索速度
	- 通过合理的组织目录结构加快对目录的检索速度,从而提高文件的存取速度
+ 文件共享:在多用户系统中,应该允许多个用户共享一个文件
+ 允许文件重名
#####7.3.1文件控制块和索引结点
文件控制块:用于描述和控制文件的数据结构
文件与文件控制块一一对应
文件目录:文件控制块的有序集合
一个文件控制块就是一个文件目录项

1. 文件控制块FCB
应含有三类信息
	+ 基本信息类
		- 文件名
		- 文件物理位置:文件在外存上的存储位置
			+ 存放文件的设备名
			+ 文件在外存上的起始盘块号
			+ 指示文件所占用的盘块数,或字节数的文件长度
		- 文件逻辑结构:指示文件是流式文件还是记录式文件,(记录数,定长/变长,)
		- 文件物理结构:指示文件是顺序文件,还是链接式文件,或索引文件
	+ 存取控制信息类
		- 文件主的存取权限
		- 核准用户的存取权限
		- 一般用户的存取权限
	+ 使用信息类
		- 文件的建立日期和时间,文件上一次修改的日期和时间,当前使用信息
2. 索引结点
	+ 索引结点的引入:
	**在检索目录文件的过程中只用到了文件名,只要找到一个目录项时,才需要从目录项中读出该文件的物理地址**
	所以文件名以外的信息在检索目录时不必调入内存
	对此:操作系统可以把文件名和文件描述信息分开,亦即,使文件描述信息单独形成一个称为**索引结点**的数据结构
	简称i结点,在文件目录中的每个目录项仅由文件名和指向该文件所对应的i结点的指针所构成
		- 检索目录的过程
			+ 文件目录存放在磁盘上,可能占用大量的盘块.
			+ 查找目录时,先将存放目录文件的第一个盘块中的目录调入内容,
			然后将给定的文件名与目录项中的文件名逐一比较
			+ 若未找到,还需要将下一盘块的目录项调入内存
	+ 磁盘索引结点:存放在磁盘上的索引结点
	每个文件有唯一的一个磁盘索引结点,包括以下内容
		- 文件的主标识符,拥有该文件的个人/小组的标识符
		- 文件类型,文件存取权限
		- 文件物理地址:每一个索引结点中含有13个地址项,它们以间接或直接的方式给出数据文件所在的盘块的编号
		- 文件长度,:以字节为单位的文件长度
		- 文件连接计数:本文件系统中所有指向该文件的文件名的指针计数
		- 文件存取时间
	+ 内存索引结点:存放在内存上的索引结点
	当文件被打开时,要将磁盘索引点拷贝到内存的索引点
	在内存索引点中增加了以下内容
		- 索引结点编号:用于标识内存索引结点
		- 状态:指示i结点是否上锁或被修改
		- 访问计数
		- 文件所属文件系统的逻辑设备编号
		- 链接指针:设置有分别指向空闲链表和散列队列的指针,,,???
#####7.3.2简单的文件目录
1. 单级文件目录:简单,但只能实现"按名存取",不能实现目录管理的其他3个要求
2. 两级文件目录:已基本上能够满足对文件目录的四方面的要求